2020 IEEE International Conference on Robotics and Automation (ICRA)
31 May - 31 August, 2020. Paris, France
Whole-Body Walking Generation using Contact Parametrization:
A Non-Linear Trajectory Optimization Approach
Stefano Dafarra1,2, Giulio Romualdi1,2, Giorgio Metta1, and Daniele Pucci1
Abstract—In this paper, we describe a planner capable what presented by authors of [6]. Nevertheless, no prior
of generating walking trajectories by using the centroidal knowledgeisinjectedonthesystemtogeneratewalkingtra-
dynamics and the full kinematics of a humanoid robot model.
jectories,butthewhole-bodymotionsresultfromaparticular
The interaction between the robot and the walking surface
choice of cost function.
is modeled explicitly through a novel contact parametrization.
The approach is complementarity-free and does not need a When planning locomotion trajectories, the deﬁnition of
predeﬁned contact sequence. By solving an optimal control contacts plays a central role. Several strategies are available
problem we obtain walking trajectories. In particular, through
in literature, here roughly summarized in four categories.
a set of constraints and dynamic equations, we model the
robot in contact with the ground. We describe the objective Fixed contact sequence, timing and location. A common
the robot needs to achieve with a set of tasks. The whole approach consists of assuming to know in advance where
optimal control problem is transcribed into an optimization thecontactswillbeestablishedandinwhichinstant[7],[8],
problem via a Direct Multiple Shooting approach and solved
[9], [10], [11]. Such choice simpliﬁes the planning problem,
withanoff-the-shelfsolver.Weshowthatitispossibletoachieve
leading to a lower computational effort. However, they need
walking motions automatically by specifying a minimal set of
references, such as a constant desired Center of Mass velocity to rely on external contact planners.
and a reference point on the ground. Predeﬁned contact sequence. During locomotion, it can
be assumed to know in advance the contact sequence. As
I. INTRODUCTION
an example, for a biped robot, it can be assumed that a
Planning locomotion trajectories for humanoid robots re- contact with the left foot will be followed by another one
quires considering high-dimensional multi-body systems in- withtherightfoot.Inotherwords,thephasesarepredeﬁned
stantiatingcontactswiththesurroundingenvironment.Given while the remaining quantities (like positions and timings)
their intrinsic under-actuation, these robots have to exploit are an output of the planner [12], [13], [14]. By specifying
the interaction with the environment and their ability to a different set of equations depending on the contact state,
change “shape” in order to move. the hybrid nature arising from the establishment of contacts
During the DARPA Robotics Challenge [1], it became is easily modeled. The time spent by each phase can be
popular to approach the locomotion problem with a hier- turned into an optimization variable. Nevertheless, in case
archical control architecture. In our previous works [2], [3] several point contacts, the deﬁnition of the various phases
we explored this concept by adopting a three layer control could become intractable.
architecture. The outer layer, i.e. the trajectory optimization MixedIntegerProgramming.Insteadofreceivingthecon-
for foot-step planning, is in charge of generating walking tact sequence as input, it is possible to use integer variables
trajectoriesstartingfromhigh-levelcommands,suchasthose to determine when a particular contact has to be considered
coming from a joystick. The output of this layer is served activeornot[15],[16].ThisapproachrequiresMixedInteger
to the receding horizon controller (RHC), also referred to as Programming tools. While providing enhanced modeling
Model Predictive Control (MPC) [4]. Its aim is to generate capabilities, the exploitation of integer variables strongly
centroidal [5] quantities obtainable by the robot without affects the computational performances, especially in case
incurring into an undesired fall state. Compared to the ﬁrst, several contacts are available. In addition, the availability of
thissecondlayeradoptsmorecomplexmodelswithashorter specialized solvers is limited.
prediction horizon. The last stage, the whole-body quadratic
Complementarity-free. Authors of [17], [18] presented
programming control is in charge of stabilizing the planned
an approach which allows simulating multi-body systems
trajectories exploiting the full robot model with a suitable
subject to contacts, without enforcing complementarity con-
Quadratic Programming formulation.
ditionsdirectly.Equivalentlyaccurateresultsareobtainedby
In this paper, we merge the ﬁrst two layers, generating
maximizingtherateofenergydissipation.Suchapproachcan
locomotion trajectories adopting the full kinematics of the
be used to generate complex movements [19], [20].
robot and the centroidal dynamics. The approach follows
In this paper, we present a planner where neither contact
sequences, locations or timings are ﬁxed a priori. Addition-
This project has received funding from the European Unions Horizon
2020researchandinnovationprogrammeundergrantagreementNo.731540 ally, we adopt a complementarity-free approach. Through a
(An.Dy). tailored parametrization of contacts, we impose complemen-
1 Dynamic Interaction Control, Istituto Italiano di Tecnologia, 16163
tarityconditionsindirectly.Sincethefullrobotkinematicsis
Genova,Italy(e-mail:name.surname@iit.it)
2 Universita` degliStudidiGenova,DIBRIS,Genova,Italy used, planned footsteps are within the robot work-space.
978-1-7281-7395-5/20/$31.00 ©2020 IEEE 1511
Authorized licensed use limited to: La Trobe University. Downloaded on September 21,2020 at 13:02:40 UTC from IEEE Xplore.  Restrictions apply. A. Notation constraints. Being a reaction force, its normal component
•• TThhee itrtahncspoomspeoonpeenrtaotofraisvedcetnoortexdisbyde(n·)o(cid:62)te.d as xi. wneigthatirvees.peInctptaorttihceulawr,alnk(inipg)(cid:62)griofu≥nd0i.sAsdudpiptoiosneadlltyo, ibneonrodner-
• I is a ﬁxed inertial frame with respect to (w.r.t.) which to avoid slippage, friction constraints should be satisﬁed:
the robot’s absolute pose is measured. Its z axis points (cid:107)t( p)(cid:62) f(cid:107)≤ρ n( p)(cid:62) f (1)
against gravity, while the x direction points forward. i i i i
• Given a function of time f(t) the dot notation denotes where ρ is the static friction coefﬁcient.
the time derivative, i.e. f˙ := df. Higher order deriva-
dt C. Contact Parametrization
tives are denoted with a corresponding amount of dots.
• 1 ∈Rn×n denotestheidentitymatrixofdimensionn. The contact force f applied to the i−th contact point is
• 0n× ∈Rn×n denotes a zero matrix. supposed to be not-niull only if the point is in contact with
n·n
• S() is the skew-symmetric operation associated with the walking surface. This condition could be represented by
R
the cross product in 3. the following equality:
• The weighted L2-norm of a vector v ∈ Rn is denoted (cid:62)
by (cid:107)v(cid:107) , where W ∈Rn×n is a weight matrix. h(ip) n(ip) if =0. (2)
∈W ∈
• ARB SO(3) and AHB SE(3) denote the rotation Such constraint can be difﬁcult to be tackled in an opti-
and transformation matrices which transform a vector
mization framework. This is due to the fact that the feasible
• enx(p·)r,eRss3ed→in tRhe3Brefturarmnsetihnetodoinreecteixopnrenssoerdmainl Ato. the sne(tpis)(cid:62)onfly=co0n,swtithuitcehdabryetiwntoerlsiencetsi,ngnaimnetlhyeho(riipg)in=. In0 tahnids
• wt(cid:2)(a·)lk,iRn3gp→l(cid:3)anRe3·g×iv2enretthuernasrgtuwmoepnet’rspxenadnidcuyl·acrodoirrdeicntaiote·nss. pthoeiinlti,netihaer icnodnespteranidnetnJcaeccoobniasntragienttsqsuianlgiﬁuclaart,iotnhu(sLIvCioQla),tinogn
nor·mal ·to n(). The composition ofIt() and n(), which most off-the-shelf solvers rely upon [22].
• Tth(e)fnun(c)tio,ndehﬁ(npe)s,Rth3e r→otatRiondemﬁantersixtheRpdliasntaen.ce be- adoInptoardseirmtpoleavpoairdamtheetrciozamtipolnic.aItniopnasrrtiecluatleadr,twoeEaqs.s(u2m),ewtoe
tween p and the walking surface. have full control over the derivative of both contact point
(cid:62) (cid:62) (cid:62)
• e1 := [1,0,0] , e2 := [0,1,0] andRe3 := [0,0,1] positions and forces:
denote the canonical basis vectors of 3.
• DV ∈ R6 is the relative velocity between frame A p˙ =u (3a)
A,D i ip
• adniadgD(·),,wRhno→se cRono×rdninisataesfuanrectidoenﬁncaesdtiinngftrhaemaergDum. ent if˙=uif, (3b)
∈ R
into the corresponding diagonal function. where u , u 3 are control inputs. Then, we can im-
ip if
pose Eq. (2) dynamically through the following constraints:
II. SYSTEMMODELING
− ≤ ≤
A. Contact Interface Modeling M u M if h( p)=0, (4a)
f if −f i (cid:54)
When performing a step, the foot can impact the ground (cid:2) (cid:3) uif = Kfif if h(ip)=0. (4b)
in a not ﬂat conﬁguration, reducing the amount of contact
When the point is in contact, u is free to take any value
wrenchesobtainablefromtheground.Atthesametime,toe- − ∈R if
in M ,M with M 3 deﬁning control bounds (Eq.
offmotionscanbeusedtoincreasethework-spaceavailable f f f
(4a)). On the other hand, if the contact point is not on the
during double support phases [21]. Given these reasons,
walking surface, the control input makes the contact force
all the various contact conﬁgurations should be taken into ∗
decreasing exponentially(cid:40)(Eq. (4b)). Deﬁning δ ( p) as a
account when planning step motions. i
binary function such that
Inordertoreducethecomplexity,itispossibletoconsider
the foot as composed by a set of points, for example four ∗ 1 if h( p)=0
points located at the corners of the foot [6], [14]. Thanks to δ (ip)= i(cid:54) , (5)
0 h( p)=0
thischoice,theseveralcontactconﬁgurationscanbemodeled (cid:0) (cid:1) i
independently,dependingonthenumberofpointsincontact. it is possible to write Eq. (4) as a set of two inequalities:
(cid:0) (cid:1)
A pure force can be applied on each contact point. In − − ∗ − ∗ ≤
K 1 δ ( p) f δ ( p)M u (6a)
caseoffourpoints,twelvevariablesdeﬁneasixdimensional − f − ∗ i i ∗ i f ≥ if
quantity, i.e. the resulting contact wrench acting on the foot. K 1 δ ( p) f +δ ( p)M u . (6b)
f i i i f if
Thisis adrawbackthat willbe addressed laterin Sec.III-D. ∗
Even if δ ( p) would require the adoption of integer vari-
i
B. Contacts Force Constraints ables,itispossibletouseacon(cid:0)tinuousap(cid:1)proximation,δ( p),
i
∈ R − namely the hyperbolic secant:
Deﬁne p 3 as the i th contact point location in
i I ∈ R
an inertial frame , and if 3 as the force exerted on δ( p)=sech k h( p) , (7)
that point. Such force is expressed on a frame located in i h i
I
p and with orientation parallel to . Since it results from where k is a user-deﬁned scaling factor. Since δ( p) = 0
i h →∞ i
the interaction of the foot with the ground, it is subject to only when p , Eq. (6) satisﬁes the LICQ condition.
i
1512
Authorized licensed use limited to: La Trobe University. Downloaded on September 21,2020 at 13:02:40 UTC from IEEE Xplore.  Restrictions apply. ∈ R ∈ R ∈ R
Given Eq. (1), it is enough to apply Eq. (6) only to the Here BvI 3, u 4 and u n are considered
,B ρ s
force component normal to the ground: if it decreases to control inputs deﬁning the base linear velocity, the quater-
zero, also planar force components have to vanish. nion derivative and the joints velocity, respectively. More
∈R
Since contact points are not supposed to penetrate the speciﬁcally,BvI isthelinearpartofBVI 6 theleft-
≥ ,B ,B
walking ground, we can impose h( p) 0. trivialized (i.e. measured in body coordinates) base velocity.
i
None of the constraints deﬁned above could prevent the
contactpointstomoveonthewalkingplanewhenincontact. E. Momentum Dynamics
In fact, even if friction constraints deﬁned in Eq. (1) are
In Sec. II-A, we consider the contact points as if they
satisﬁed, the contact points are still free to move on the
havethepossibilityofexertingaforcewiththeenvironment.
contact surface. Force and position variables are (almost)
We can describe the effect of these contact forces through
independent at this stage. It is possible to prevent planar
the momentum, or centroidal, dynamics. This choice is
motionswhenincontactby(cid:0)limiting(cid:1)theeffectofthecontrol supported by the fact that the momenutm dynamics depends
iwnhpeurteuikp atl(∈oipn)gR(cid:62)tihpi˙es=palatanunasrehrc-dokemtﬁhpn(oeindpe)nstc[sea:1lineg2](cid:62)fauctiopr. Eq. ((88)) ooronfblmyotao∈stnsoRt(taChleomMcoo)mnpteaoncsttiutfimoo∈nr,c,weRxsiC,thotMhGe¯∈ihrRl=o3c.a(cid:2)DtG¯ioehnﬁpn(cid:62)aenGGd¯¯hhoωn∈(cid:62)t(cid:3)Rh(cid:62)e6wcaeshntethreeer
multiplietsthecontrolinputalongtheplanardirectiontozero G¯hp 3 and G¯hω 3 are respectively the linear and
angular momentum. This quantity is expressed in a frame
when h( p) is null and, at the same time, it will reduce the I
i oriented as the inertial frame , with the origin placed on
velocity when the contact point is approaching the ground. I
the CoM position. Such frame(cid:20)is called G[ (cid:21)] or simply G¯.
It is possible to rewrite Eq. (8) as (cid:88)
The momentum dynamics has the following form:
where the function τ(·)ip˙:=R3τ→(ipR)u3i×p(cid:0)(cid:0)3, is deﬁn(cid:1)(cid:1)edas: (9) G¯h˙ =m1g¯+ i S(ip−13xCoM) if (13a)
τ( p)=IR diag ttaannhh kkthh((iip)) . (10) x˙CoM = m(G¯hp) (13b)
i plane t p
1 with m the total mass of the robot, g¯=[00−g 000]T. We
also need to make sure that the integrated CoM corresponds
Note that, from now on, u is assumed to be deﬁned
ip to the one obtained via the joint variables. This is done
in plane coordinates. Thus, the normal component of the
(cid:62) through an additional constraint:
velocity is directly affected by e u . Also, it is necessary
∈3 −ip ∈ R I I
to bound this control input, uip [ MV,MV],MV 3, xCoM =CoM( pB, ρB,s) (14)
toproperlyexploittheeffectofthehyperbolictangent.Note
I I
that Eq. (8) allows avoiding the use of complementarity where CoM( p , ρ ,s) is the functionmapping base pose
B B
conditions along planar directions. andjointpositionstotheCoMposition.Whilethisconstraint
deﬁnes a link between the linear momentum and the joint
D. Contact Point Position Consistency
variables, the same would not hold for the angular part. To
While each contact point is supposed to be independent this end, we can exploit the Centroidal Momentum Matrix
from the control point of view, they all need to remain on [5] (JCMM). In fact, the robot angular momentum can be
the same surface and maintain a constant relative distance, deﬁned as a function of the base and joints velocity:
since they belong to the same rigid body. At the same time,
(cid:2) (cid:3)
we want them to be within the workspace reachable by the G¯hω =[03×3 13]JCMMν (15)
robot legs. We can achieve both the objectives by enforcing (cid:62)
the following constraint on each of the contact points: where ν = BVI,B us . Here, the base angular velocity
ip=IHfootfootip, (11) BthωroIu,Bghcthane mbeapsGub[s2ti3tu,tSeedctwiointh1.t5h.e4],qusuactehrnthioant derivative
wherefoot pisthe(ﬁxed)positionofthecontactpointwithin G I
i BωI =2 ( ρ )u .
the foot surface, expressed in foot coordinates. Here, the ,B B ρ
I
transformIation∈mRatrix Hfoot would depIend ∈onHthe base Some additional constraints can be considered:
position p 3, the base quaternion ρ and the
B ∈ R B ≤ (cid:62)
jjtooakiinnettnss.incAotosnﬁcaogcnuosrnaidtsieeorqnautiesonncea,ntdhnteh,efwuflioltlhkloinwneimnbgeaitdnicygsntaohmfeitchneueqmruobabetoirotnoissf xCo−M,Mzmhiωn ≤eG¯3hxωC≤oMMhω ((1166ba))
have to be considered: Eq (16a) avoids solutions which would bring the CoM
I I position too close or below the ground. Eq. (16b) provides
p˙ = R BvI (12a) ∈ R
Iρ˙Bb =uρ B ,B (12b) amnomupenpteurma.nTdhelosewecronbsotruanindtsMavhoωid trajec3tortoiesththeatanwgouulladr
s˙ =u . (12c) cause excessive motions or let the robot falling.
s
1513
Authorized licensed use limited to: La Trobe University. Downloaded on September 21,2020 at 13:02:40 UTC from IEEE Xplore.  Restrictions apply. F. Feet Minimum Lateral Distance D. Force regularization task
While taking steps, we need to make sure that the robot While considering each single contact force in a foot as
legs do not collide with each other. Self collision constraints independent, they still belong to a single body part. Thus,
are usually hard to be considered and may slow down con- we prescribe the contact forces in a foot to be as similar as
sistently the determination of a solution. A simpler solution possible, refraining from using partial contacts if not strictly
(cid:13) (cid:13)
consists in avoiding the left leg to be on the right of the necessary. This can(cid:88)be(cid:88)obtain(cid:13)(cid:13)ed throug(cid:88)h the f(cid:13)(cid:13)ollowing:
other leg. Consequently, cross steps are forbidden. Let us (cid:13) (cid:13)
(cid:13) (cid:13)
consider a frame attached to the right foot with the positive # (cid:13) # (cid:13)2
− 1 − 1
y direction point−ing toward left. In this case, it is sufﬁcient Γregf = 2 if # jf . (20)
to impose the y component of the rx (i.e. the relative l,r i j
l
position of the left foot expressed in the right foot frame)
(cid:62) ≥ E. Joint regularization task
to be greater than a given quantity, i.e. e2rxl dmin.
The joint conﬁguration s is part of the optimization
III. TASKS variables. In order to prevent the planner from providing
We present the set of tasks used to plan a walking solutions with huge joint variations, we introduce a regu-
(cid:13) (cid:13)
trajectory.Whileconstraintsdeﬁnethemodelandthecontrol larization task for joint v(cid:13)ariables: (cid:13)
limitations, the tasks embed the planning objectives.
1 − ∗
A. Contact point centroid position task Γregs = 2 s˙+Ks(s s ) 2Wj (21)
∗
In order to make the robot moving toward a desired with s the desired joint conﬁgurations and W a weight
−j − ∗
position, we minimize the L2 norm of the error between matrix.Theminimumofthiscostiswhens˙ = K (s s ),
∈ R × s
a point attached to the robot and its desired position in an with K n n. When this equality holds, joint values
s ∗
absolute frame. In particular, we select the centroid of the converge exponentially to their reference s . Hence, joint
contact points as target, thus avoiding to specify a desired velocitiesandjointpositionsareregularizedatthesametime.
placement for each foot:
F. Swing height task
1(cid:107) − ∗(cid:107)
Γ#p = 2(cid:80)#p (cid:80)#p 2W# (17) When performing a step, the swing foot clearance usually
ensures some level of robustness with respect to ground
where # is the number of contact points in a single foot.
Thus, we have p = 1 # p and p∗ ∈ R3 is a asperity. Nevertheless, since the soil proﬁle is supposed to
# 2# l,r i i # be known in advance, a solution satisfying all the equations
user-deﬁned reference value.
described in Sec. II may require the swing foot to be raised
B. CoM linear velocity task just few millimeters from the ground. In order to specify a
(cid:13) (cid:13)
While walking, we want the robot to keep a constant desired swin(cid:88)g he(cid:88)ight, w(cid:13)(cid:13)(cid:16)e impose the(cid:17)following cos(cid:13)(cid:13)t:
(cid:13) (cid:13)
forward motion. In fact, since the positions of the feet are
nwoitthscthrieptseadm,eitfmooaty.Bbeyproeqssuiibrliengtoapcloannsttwanotcfoonrwseacrudtivveeloscteitpys, Γswing = # 12 e(cid:62)3ip−sh∗ [e1 e2](cid:62)uip . (22)
l,r i
such phenomena can be avoided. This task is deﬁned as:
It penalizes the distance between the z-component of each
1(cid:107) − ∗(cid:107) ∗ ∈ R
ΓG¯hp = 2 G¯hp mvG 2Wv (18) cthoentcaocrtrepsopinotndpionsgitipolnanfarromvelaocdietysiriesdnhoetignhutll.shTriviallyw, thheins
∗ ∈R
withv 3adesiredCoMvelocity.ThematrixW selects cost has two minima: when the planar velocity is zero (thus
G v
and weights the different directions separately. the point is not moving) or when the height of the point is
equal to the desired one.
C. Frame orientation task
While moving, we want a robot frame to be oriented in IV. OPTIMALCONTROLPROBLEM
I ∗
a speciﬁc orientation R . In particular, we weight the
frame I I ∗(cid:62) I Given the set of equations listed in Sec. II and the tasks
distance of the rotation matrix R˜frame = Rframe Rframe describedinSec.IIIitispossibletodeﬁneanoptimalcontrol
fromtheidentity.Havingtoexpressthistaskinvectorform,
I problem, whose complete formulation is presented below.
we convert R˜frame into a quaternion (through the function Here, the vector w contains the set of weights deﬁning the
quatwhichimplemen(cid:13)tstheRodriguezformu(cid:13)la)andweight
(cid:13) (cid:16) (cid:17) (cid:13) relative “importance” of each task.
its difference from the(cid:13)identity quaternion I .(cid:13)Namely:
(cid:13) q(cid:13)
1 − 2 A. Problem deﬁ(cid:104)nition (cid:105)
Γframe = 2 quat AR˜frame Iq . (19)
(cid:62)
This corresponds to a simpliﬁed version of the quaternion
difference metric listed in [24], under the assumption for minXi,mUize Γ#p ΓG¯hp Γframe Γregf Γregs Γswing w
quat to always return a quaternion with positive real value. subject to :
1514
Authorized licensed use limited to: La Trobe University. Downloaded on September 21,2020 at 13:02:40 UTC from IEEE Xplore.  Restrictions apply. •
Dynamical Constraints
∀
if˙=uif (cid:88)(cid:20)∀ contact poin(cid:21)t (23a)
p˙ =τ( p)u contact point (23b)
i i ip
1
G¯h˙ =mg¯+ S(ip−3xCoM) if (23c)
i
1
x˙CoM = m(G¯hp) (23d)
I I
p˙ = R BvI (23e)
I B B ,B (a)t=0.5s (b)t=1.5s (c)t=2.5s (d)t=3.5s
ρ˙ =u (23f)
B ρ Fig. 1: Snapshots of the generated walking motion. The red
s˙ =us (23g) arrowsindicatetheforcerequiredateachcontactpointscaled
• by a factor of 0.01.
Equality Constraints
∀
ip=AHfootfootip contact point (24a)
I I
xCoM =CoM( pB, ρB,s)  (24b) B. Considerations
BvI The optimal control problem described in Sec. IV-A is
G¯hω = [03×3 13]JCMM 2G(IρB,B)uρ (24c) built such that (almost) no constraint is task speciﬁc. As
a consequence, it is particularly important to deﬁne the
u
s
cost function carefully since the solution will be a trade-off
(cid:107)I (cid:107)
ρB 2 =1 (24d) betweenallthevarioustasks.Ontheotherhand,thedetailed
• model of the system allows achieving walking motions
Inequality Constraints
without specifying a desired CoM trajectory or by ﬁxing the
(cid:62) ≥
n( p) f 0 (cid:0) (cid:1) (25a) angular momentum to zero. Nevertheless, due to the limited
i i
(cid:107)t( p)(cid:62) f(cid:107)≤ρ n( p)(cid:0)(cid:62) f (cid:1) (25b) time horizon, it is better to prevent the solver from ﬁnding
i i i i
≥ − − − solutions which would bring the robot to unfeasible states
u K 1 δ( p) f δ( p)M (25c)
if ≤ − f − i i i f in future planner iterations. To this end, Eq. (16a) and Eq.
− uif ≤ K≤f 1 δ(ip) if +δ(ip)Mf (25d) (16b) have been added, using reasonably large bounds.
M u M (25e) Another possible effect resulting from the application
V ≥ ip V
h( p) 0 (25f) of the Receding Horizon principle, is the emergence of
i
(cid:62) ≥ “procrastination” phenomena. Due to the moving horizon,
e2rxl ≤d(cid:62)min (25g) thesolvermaycontinuouslydelayinactuatingmotions,since
xCo−M,zmin ≤e3xC≤oM (25h) the task keeps being shifted in time. A simple ﬁx to this
Mhω G¯hω Mhω (25i) phenomenaistoincreasetheweightsw withtime,suchthat
X U it is more convenient to reach a goal position earlier.
Here, the state variables are those derived in time, all
Finally,giventhattheproblemunderconsiderationisnon-
the others. More speciﬁcally:  
  convex, the optimizer will ﬁnd a local minimum. This may
 
    result in a sub-optimal solution for the given tasks.
 if   
    During the ﬁrst iteration, the solver is initialized by
 i.p   uif  simply translating the whole robot in the desired position.
 ..   u.ip  In successive iterations, the solver is warm-started with the
X = G¯h , U = ..  (26) solution previously computed.
xICoM BvI,B
p u V. RESULTS
I B ρ
ρB us The optimal control problem described in Sec. IV is used
s to generate a walking motion. The integration step is set
. to 100ms, while the prediction horizon is 2s. After each
.
where the symbol . represents the repetition of variables for iteration of the MPC controller, the previously computed
each contact point. state is used as a feedback. Regarding the scaling factors,
TheoptimalcontrolproblemissolvedusingaDirectMul- we use k = 300 and k = 10.0. They appeared to
h t
tiple Shooting method [22]. The system dynamics, deﬁned be reasonable values for having meaningful simulations of
in Eq. (23), is discretized adopting an implicit trapezoidal contacts. In addition, these values are robot and ground
method with a ﬁxed integration step. The corresponding independent, since they depend only on the position of a
optimization problem is solved thanks to Ipopt [25]. contact point with respect to the ground.
ThewalkingtrajectoriesaregeneratedusingtheReceding The trajectories have been generated using the iCub hu-
Horizon Principle [26], adopting a ﬁxed prediction window. manoid [27] robot model on a 7th generation Intel® Core
1515
Authorized licensed use limited to: La Trobe University. Downloaded on September 21,2020 at 13:02:40 UTC from IEEE Xplore.  Restrictions apply. Figure 1 shows some snapshots of the ﬁrst generated
100 step. Also, it can be observed the effect of the contact
0.06
parametrization described in Sec. II-C from Fig. 2. The
0.05 80
normal force decreases to zero as soon as the foot starts
0.04 60 leaving the ground, and then it grows again at touchdown.
0.03 It is possible to recognize the different walking phases, even
40
though they are not planned a priori.
0.02
20 Figure 3 presents the planned CoM position. Here, it is
0.01
possible to notice that x position grows at a constant rate.
0 0
ThisisadirectconsequenceofthetaskontheCoMvelocity.
0 5 10 15 20
Figure4showstheplannedangularmomentum,whichisnot
Fig. 2: Normal force and normal position of a contact point ﬁxedtozero.Althoughitislimitedto10kgm2/s,suchlimit
of the right foot plotted together. is never reached. Similarly, the bound on the CoM height,
xCoM,zmin, is set to half of the initial robot height, but such
constraint is never activated.
Itisworthstressingthatnoneofthetasksdescribedabove
1
deﬁnehowandwhentoraisethefoot.Byprescribingarefer-
0.8 enceforthecentroidofthecontactpointsandbypreventing
themotiononthecontactsurface,swingmotionsareplanned
0.6
automatically. Nevertheless, this advantage comes with a
0.4
cost. It is difﬁcult to deﬁne a desired swing time and, more
0.2 importantly, the relative importance of each task, i.e. the
values of w, must be chosen carefully. During experiments,
0
we adopted an incremental approach. We added the tasks
-0.2 one by one, starting from Γ and then we gradually reﬁne
#p
0 5 10 15 20 the walking motion by tuning a cost at a time.
Fig. 3: Planned CoM position.
VI. CONCLUSIONS
This paper presents a planner capable of generating walk-
i7@2.8GHz laptop. We assume the ground to be ﬂat, while
ingtrajectoriesusingaminimalsetofreferences.Itconsiders
wecontrol23 oftherobotjoints.Foreach foot,weconsider
thecentroidalmomentumoftherobotanditsfullkinematics
four contact points located at the vertexes of the rectangle
to plan dynamically consistent step motions. The modelling
enclosing the robot foot. Concerning the references, the
of contacts makes use of a novel parametrization approach,
desired position for the centroid of the contact points is
allowing to model the interface between the robot and the
moved 10cm along the walking direction every time the
ground with a set of continuous equations. Currently, this
robot performs a step. A simple state machine, where the
model does not consider impacts nor contact sliding. The
reference is moved as soon as a step is completed, is
considerationofslip-turnmotions[28]isleftasfuturework.
enough to generate a continuous walking pattern. The speed
Theresultshavetobeconsideredasaninitialvalidationof
is modulated by prescribing a ﬁxed desired CoM forward
thegeneratedtrajectorieswhentheiCubmodelisadopted.In
velocity equal to 5cm/s.
particular,itisshownthatwalkingtrajectoriescanemergeby
specifyingamovingreferenceforthecentroidofthecontact
points and the desired CoM velocity only.
The planner considers relatively large time-steps. This
8
enables the insertion of another control loop at higher
6 frequency,whosegoalistostabilizetheplannedtrajectories.
As a future work, we will consider connecting this planner
4
to the whole-body controller presented in [2].
2
The main bottleneck is represented by the computational
0 time. A single planner iteration may take from slightly less
than a second to more than a minute. This prevents an
-2
online implementation on the real robot. On the other hand,
-4 the continuous formulation of the optimal control problem
0 5 10 15 20 allows the application of techniques, like those presented in
[29], [30], which do not rely on the transcription to a non-
Fig. 4: Planned angular momentum.
linear programming problem.
1516
Authorized licensed use limited to: La Trobe University. Downloaded on September 21,2020 at 13:02:40 UTC from IEEE Xplore.  Restrictions apply. REFERENCES [20] Y. Tassa, T. Erez, and E. Todorov, “Synthesis and stabilization of
complex behaviors through online trajectory optimization,” in 2012
IEEE/RSJInternationalConferenceonIntelligentRobotsandSystems.
[1] S.Feng,E.Whitman,X.Xinjilefu,andC.G.Atkeson,“Optimization-
IEEE,2012,pp.4906–4913.
based full body control for the darpa robotics challenge,” Journal of
[21] R. J. Grifﬁn, G. Wiedebach, S. Bertrand, A. Leonessa, and J. Pratt,
FieldRobotics,vol.32,no.2,pp.293–312,2015.
“Straight-legwalkingthroughunderconstrainedwhole-bodycontrol,”
[2] S. Dafarra, G. Nava, M. Charbonneau, N. Guedelha, F. Andradel,
in2018IEEEInternationalConferenceonRoboticsandAutomation
S. Traversaro, L. Fiorio, F. Romano, F. Nori, G. Metta, et al., “A
(ICRA). IEEE,2018,pp.1–5.
control architecture with online predictive planning for position and
[22] J.T.Betts,Practicalmethodsforoptimalcontrolandestimationusing
torque controlled walking of humanoid robots,” in 2018 IEEE/RSJ
nonlinearprogramming. Siam,2010,vol.19.
International Conference on Intelligent Robots and Systems (IROS).
[23] B. Graf, “Quaternions and dynamics,” Available at https://arxiv.org/
IEEE,2018,pp.1–9.
pdf/0811.2889.pdf,2008.
[3] G. Romualdi, S. Dafarra, Y. Hu, and D. Pucci, “A benchmarking of
[24] D. Q. Huynh, “Metrics for 3d rotations: Comparison and analysis,”
dcmbasedarchitecturesforpositionandvelocitycontrolledwalkingof
JournalofMathematicalImagingandVision,vol.35,no.2,pp.155–
humanoid robots,” in 2018 IEEE-RAS 18th International Conference
164,2009.
onHumanoidRobots(Humanoids). IEEE,2018,pp.1–9.
[25] A.Wa¨chterandL.T.Biegler,“Ontheimplementationofaninterior-
[4] D.Mayne,J.Rawlings,C.Rao,andP.Scokaert,“Constrainedmodel
point ﬁlter line-search algorithm for large-scale nonlinear program-
predictivecontrol:Stabilityandoptimality,”Automatica,vol.36,no.6,
ming,”Mathematicalprogramming,vol.106,no.1,pp.25–57,2006.
pp.789–814,2000.
[26] D.Q.MayneandH.Michalska,“Recedinghorizoncontrolofnonlin-
[5] D. E. Orin and A. Goswami, “Centroidal momentum matrix of a earsystems,”IEEETransactionsonautomaticcontrol,vol.35,no.7,
humanoid robot: Structure and properties,” Intelligent Robots and pp.814–824,1990.
Systems, 2008. IROS 2008. IEEE/RSJ International Conference on, [27] L.Natale,C.Bartolozzi,D.Pucci,A.Wykowska,andG.Metta,“icub:
pp.653–659,2008. Thenot-yet-ﬁnishedstoryofbuildingarobotchild,”ScienceRobotics,
[6] H.Dai,A.Valenzuela,andR.Tedrake,“Whole-bodymotionplanning vol.2,no.13,2017.
with centroidal dynamics and full kinematics,” in 2014 IEEE-RAS [28] K.Miura,F.Kanehiro,K.Kaneko,S.Kajita,andK.Yokoi,“Slip-turn
InternationalConferenceonHumanoidRobots,pp.295–302. forbipedrobots,”IEEETransactionsonRobotics,vol.29,no.4,pp.
[7] P. Fernbach, S. Tonneau, and M. Ta¨ıx, “Croc: Convex resolution of 875–887,2013.
centroidal dynamics trajectories to provide a feasibility criterion for [29] M. Neunert, M. Sta¨uble, M. Giftthaler, C. D. Bellicoso, J. Carius,
themulticontactplanningproblem,”in2018IEEE/RSJInternational C.Gehring,M.Hutter,andJ.Buchli,“Whole-bodynonlinearmodel
ConferenceonIntelligentRobotsandSystems(IROS). IEEE,2018. predictive control through contacts for quadrupeds,” IEEE Robotics
[8] A. Herzog, N. Rotella, S. Schaal, and L. Righetti, “Trajectory gen- andAutomationLetters,vol.3,no.3,pp.1458–1465,2018.
eration for multi-contact momentum control,” in Humanoid Robots [30] F. Farshidian, E. Jelavic, A. Satapathy, M. Giftthaler, and J. Buchli,
(Humanoids), 2015 IEEE-RAS 15th International Conference on. “Real-time motion planning of legged robots: A model predictive
IEEE,2015,pp.874–880. control approach,” in 2017 IEEE-RAS 17th International Conference
[9] M.Posa,S.Kuindersma,andR.Tedrake,“Optimizationandstabiliza- onHumanoidRobotics(Humanoids). IEEE,2017,pp.577–584.
tionoftrajectoriesforconstraineddynamicalsystems,”in2016IEEE
InternationalConferenceonRoboticsandAutomation(ICRA). IEEE,
2016,pp.1366–1373.
[10] M. De Lasa, I. Mordatch, and A. Hertzmann, “Feature-based loco-
motion controllers,” ACM Transactions on Graphics (TOG), vol. 29,
no.4,pp.1–10,2010.
[11] S.Dafarra,F.Romano,andF.Nori,“Arecedinghorizonpushrecovery
strategy for balancing the icub humanoid robot,” in International
Conference on Robotics in Alpe-Adria Danube Region. Springer,
2017,pp.297–305.
[12] A. W. Winkler, D. C. Bellicoso, M. Hutter, and J. Buchli, “Gait
and trajectory optimization for legged systems through phase-based
end-effectorparameterization,”IEEERoboticsandAutomationLetters
(RA-L),vol.3,pp.1560–1567,July2018.
[13] J.Carpentier,S.Tonneau,M.Naveau,O.Stasse,andN.Mansard,“A
versatileandefﬁcientpatterngeneratorforgeneralizedleggedlocomo-
tion,” in Robotics and Automation (ICRA), 2016 IEEE International
Conferenceon. IEEE,2016,pp.3555–3561.
[14] S.CaronandQ.-C.Pham,“Whentomakeastep?tacklingthetiming
probleminmulti-contactlocomotionbytopp-mpc,”in2017IEEE-RAS
17th International Conference on Humanoid Robotics (Humanoids).
IEEE,2017,pp.522–528.
[15] R. Deits and R. Tedrake, “Footstep planning on uneven terrain
with mixed-integer convex optimization,” in Humanoid Robots (Hu-
manoids),201414thIEEE-RASInternationalConferenceon.
[16] B.Aceituno-Cabezas,C.Mastalli,H.Dai,M.Focchi,A.Radulescu,
D.G.Caldwell,J.Cappelletto,J.C.Grieco,G.Ferna´ndez-Lo´pez,and
C.Semini,“Simultaneouscontact,gait,andmotionplanningforrobust
multileggedlocomotionviamixed-integerconvexoptimization,”IEEE
RoboticsandAutomationLetters,vol.3,no.3,pp.2531–2538,2018.
[17] E. Todorov, “A convex, smooth and invertible contact model for
trajectory optimization,” in 2011 IEEE International Conference on
RoboticsandAutomation. IEEE,2011,pp.1071–1076.
[18] E.DrumwrightandD.A.Shell,“Modelingcontactfrictionandjoint
frictionindynamicroboticsimulationusingtheprincipleofmaximum
dissipation,” in Algorithmic foundations of robotics IX. Springer,
2010,pp.249–266.
[19] I. Mordatch, E. Todorov, and Z. Popovic´, “Discovery of complex
behaviorsthroughcontact-invariantoptimization,”ACMTransactions
onGraphics(TOG),vol.31,no.4,p.43,2012.
1517
Authorized licensed use limited to: La Trobe University. Downloaded on September 21,2020 at 13:02:40 UTC from IEEE Xplore.  Restrictions apply. 